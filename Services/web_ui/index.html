<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Date Juridice ‚Äì Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#0b1220; color:#e6edf3; margin:0}
    .wrap{max-width:1400px; margin:0 auto; padding:24px}
    .grid{display:grid; gap:16px}
    .grid2{grid-template-columns:1fr 1fr}
    .grid3{grid-template-columns:repeat(3, 1fr)}
    .card{background:#0f1a2e; border:1px solid #23314d; border-radius:14px; padding:16px}
    h1{margin:0 0 10px 0; font-size:22px}
    h2{margin:0 0 16px 0; font-size:16px; color:#b7c5ff}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    input,button{border-radius:10px; border:1px solid #2a3a5e; background:#0b1220; color:#e6edf3; padding:10px 12px}
    button{cursor:pointer; background:#1b2f5b}
    button:hover{background:#25407a}
    .pill{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid #2a3a5e}
    .ok{color:#4cffb0}
    .bad{color:#ff6b6b}
    pre{white-space:pre-wrap; word-break:break-word; background:#081024; border:1px solid #23314d; padding:12px; border-radius:12px; max-height:360px; overflow:auto}
    .muted{color:#98a6c7; font-size:13px}
    .chart-container{position:relative; height:300px; margin-top:8px}
    .chart-container-small{position:relative; height:250px; margin-top:8px}
    .stats-summary{display:flex; gap:16px; margin-bottom:16px; flex-wrap:wrap}
    .stat-box{flex:1; min-width:140px; background:#081024; padding:12px 16px; border-radius:10px; border:1px solid #23314d}
    .stat-label{font-size:12px; color:#98a6c7; margin-bottom:4px}
    .stat-value{font-size:24px; font-weight:600; color:#4cffb0}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th{background:#081024; padding:10px; text-align:left; color:#b7c5ff; font-weight:500; position:sticky; top:0}
    td{padding:8px; border-bottom:1px solid #23314d}
    tr:hover{background:#081024}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üìä Date Juridice ‚Äì Dashboard</h1>
    <div class="muted">UI ‚Üí Gateway (/api) ‚Üí microservicii (extractor + ingestion)</div>

    <div class="grid grid2" style="margin-top:16px">
      <div class="card">
        <h2>Status servicii</h2>
        <div class="row">
          <button onclick="health()">Check</button>
          <span id="svcPills"></span>
        </div>
        <div class="row" style="margin-top:12px">
          <button onclick="loadEnrichedCases()">üì• √éncarcƒÉ date procesate</button>
          <span class="muted">Afi»ôeazƒÉ toate cazurile din baza de date</span>
        </div>
      </div>

      <div class="card">
          <h2>Ingestion /run</h2>

          <div class="row" style="gap:14px">
            <div class="pill">
              <span>Data</span>
              <label style="display:inline-flex;align-items:center;gap:8px">
                <input id="modeToggle" type="checkbox" onchange="toggleMode()" />
                <span class="muted">PerioadƒÉ</span>
              </label>
            </div>

            <!-- Single date -->
            <div id="singleWrap" class="row">
              <input id="singleDate" type="date" />
            </div>

            <!-- Range -->
            <div id="rangeWrap" class="row" style="display:none">
              <input id="startDate" type="date" />
              <span class="muted">‚Üí</span>
              <input id="endDate" type="date" />
            </div>

            <button onclick="runIngestion()">‚ñ∂Ô∏è RuleazƒÉ</button>
          </div>

          <div class="muted" style="margin-top:8px">
            ApeleazƒÉ ms_ingestion_web prin gateway.
          </div>
        </div>
    </div>

    <div class="grid" style="margin-top:16px">
      <div class="card">
        <h2>Extract TXT (dosar)</h2>
        <div class="row">
          <input type="file" id="txtFile" />
          <button onclick="extractTxt()">üîç Extrage</button>
        </div>
        <div class="muted" style="margin-top:8px">√éncarci TXT ‚Üí prime»ôti JSON/text cu date extrase.</div>
      </div>

      <div class="card">
        <h2>Output</h2>
        <pre id="out">{}</pre>
      </div>
    </div>

    <!-- Summary Stats -->
    <div class="card" style="margin-top:16px" id="summaryCard" style="display:none">
      <h2>üìà Statistici generale</h2>
      <div class="stats-summary">
        <div class="stat-box">
          <div class="stat-label">Total cazuri</div>
          <div class="stat-value" id="statTotal">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Instan»õe</div>
          <div class="stat-value" id="statCourts">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">JudecƒÉtori identifica»õi</div>
          <div class="stat-value" id="statJudges">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Articole men»õionate</div>
          <div class="stat-value" id="statArticles">0</div>
        </div>
      </div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid2" style="margin-top:16px" id="chartsSection" style="display:none">
      <div class="card">
        <h2>üèõÔ∏è Top 10 Instan»õe</h2>
        <div class="chart-container">
          <canvas id="chartByCourt"></canvas>
        </div>
      </div>

      <div class="card">
        <h2>‚öñÔ∏è Distribu»õie pe domenii</h2>
        <div class="chart-container-small">
          <canvas id="chartByDomain"></canvas>
        </div>
      </div>

      <div class="card">
        <h2>üìã Tipuri de documente</h2>
        <div class="chart-container-small">
          <canvas id="chartByDocType"></canvas>
        </div>
      </div>

      <div class="card">
        <h2>‚úÖ Solu»õii pronun»õate</h2>
        <div class="chart-container-small">
          <canvas id="chartBySolution"></canvas>
        </div>
      </div>
    </div>

    <!-- Data Table -->
    <div class="card" style="margin-top:16px" id="tableSection" style="display:none">
      <h2>üìÑ Tabel ‚Äì Date extrase</h2>
      <div style="overflow:auto; max-height:500px">
        <table id="dataTable">
          <thead>
            <tr>
              <th>Instan»õa</th>
              <th>Localitate</th>
              <th>Dosar</th>
              <th>Tip document</th>
              <th>Domeniu</th>
              <th>JudecƒÉtor</th>
              <th>Avocat</th>
              <th>Articole</th>
              <th>Procedura</th>
              <th>Solu»õie</th>
              <th>Data pronun»õƒÉrii</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    const out = (x) => document.getElementById("out").textContent = x;

    function esc(v){
      return (v ?? "")
        .toString()
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");
    }

    // Chart instances
    let chartByCourt, chartByDomain, chartByDocType, chartBySolution;

    // Chart.js global config
    Chart.defaults.color = '#98a6c7';
    Chart.defaults.borderColor = '#23314d';
    Chart.defaults.font.family = 'system-ui, -apple-system, Segoe UI, Roboto, Arial';

    /* =======================
       TABEL DATE EXTRASE TXT
       ======================= */
    function renderExtractedTable(data) {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";

      const rows = Array.isArray(data) ? data : [data];

      for (const d of rows) {
        const ext = d.extracted || d;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(ext.instanta || d.instanta)}</td>
          <td>${esc(ext.localitate || d.localitate)}</td>
          <td>${esc(ext.dosar_nr || d.dosar)}</td>
          <td>${esc(ext.doc_type)}</td>
          <td>${esc(ext.domain)}</td>
          <td>${esc(ext.judecator ?? "‚Äî")}</td>
          <td>${esc(ext.avocat ?? "‚Äî")}</td>
          <td>${esc((ext.articole || []).slice(0,3).join(", "))}${(ext.articole||[]).length > 3 ? '...' : ''}</td>
          <td>${esc(ext.procedura)}</td>
          <td><b>${esc(ext.solutie)}</b></td>
          <td>${esc(ext.data_pronuntarii || d.data_pron)}</td>
        `;
        tbody.appendChild(tr);
      }

      document.getElementById("tableSection").style.display = "block";
    }

    /* =======================
       STATISTICI
       ======================= */
    function groupCount(items, keyFn) {
      const m = new Map();
      for (const it of items) {
        const k = keyFn(it) ?? "N/A";
        m.set(k, (m.get(k) || 0) + 1);
      }
      return [...m.entries()].sort((a,b)=>b[1]-a[1]);
    }

    function renderStats(items){
      if (!items || items.length === 0) return;

      // Summary stats
      const uniqueCourts = new Set();
      const uniqueJudges = new Set();
      let totalArticles = 0;

      items.forEach(item => {
        const ext = item.extracted || item;
        if (ext.instanta) uniqueCourts.add(ext.instanta);
        if (ext.judecator) uniqueJudges.add(ext.judecator);
        if (ext.articole) totalArticles += ext.articole.length;
      });

      document.getElementById("statTotal").textContent = items.length;
      document.getElementById("statCourts").textContent = uniqueCourts.size;
      document.getElementById("statJudges").textContent = uniqueJudges.size;
      document.getElementById("statArticles").textContent = totalArticles;

      document.getElementById("summaryCard").style.display = "block";
      document.getElementById("chartsSection").style.display = "grid";

      // Chart 1: Top courts
      const byCourt = groupCount(items, x => {
        const ext = x.extracted || x;
        return ext.instanta || x.instanta;
      });

      if (chartByCourt) chartByCourt.destroy();
      chartByCourt = new Chart(document.getElementById("chartByCourt"), {
        type: 'bar',
        data: {
          labels: byCourt.slice(0,10).map(x=>x[0]),
          datasets: [{
            label: 'NumƒÉr hotƒÉr√¢ri',
            data: byCourt.slice(0,10).map(x=>x[1]),
            backgroundColor: 'rgba(75, 130, 255, 0.8)',
            borderColor: 'rgba(75, 130, 255, 1)',
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { beginAtZero: true, ticks: { stepSize: 1 } }
          }
        }
      });

      // Chart 2: Domains
      const byDomain = groupCount(items, x => {
        const ext = x.extracted || x;
        return ext.domain || 'Nespecificat';
      });

      if (chartByDomain) chartByDomain.destroy();
      chartByDomain = new Chart(document.getElementById("chartByDomain"), {
        type: 'doughnut',
        data: {
          labels: byDomain.map(x=>x[0]),
          datasets: [{
            data: byDomain.map(x=>x[1]),
            backgroundColor: [
              'rgba(255, 99, 132, 0.8)',
              'rgba(54, 162, 235, 0.8)',
              'rgba(255, 206, 86, 0.8)',
              'rgba(75, 192, 192, 0.8)',
              'rgba(153, 102, 255, 0.8)',
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      // Chart 3: Document types
      const byDocType = groupCount(items, x => {
        const ext = x.extracted || x;
        return ext.doc_type || 'Nespecificat';
      });

      if (chartByDocType) chartByDocType.destroy();
      chartByDocType = new Chart(document.getElementById("chartByDocType"), {
        type: 'pie',
        data: {
          labels: byDocType.map(x=>x[0]),
          datasets: [{
            data: byDocType.map(x=>x[1]),
            backgroundColor: [
              'rgba(255, 159, 64, 0.8)',
              'rgba(75, 192, 192, 0.8)',
              'rgba(153, 102, 255, 0.8)',
              'rgba(255, 99, 132, 0.8)',
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      // Chart 4: Solutions
      const bySolution = groupCount(items, x => {
        const ext = x.extracted || x;
        return ext.solutie || 'Nespecificat';
      });

      if (chartBySolution) chartBySolution.destroy();
      chartBySolution = new Chart(document.getElementById("chartBySolution"), {
        type: 'doughnut',
        data: {
          labels: bySolution.map(x=>x[0]),
          datasets: [{
            data: bySolution.map(x=>x[1]),
            backgroundColor: [
              'rgba(75, 192, 192, 0.8)',
              'rgba(255, 99, 132, 0.8)',
              'rgba(255, 206, 86, 0.8)',
              'rgba(153, 102, 255, 0.8)',
              'rgba(54, 162, 235, 0.8)',
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    /* =======================
       INGESTION JOB
       ======================= */
    async function pollJob(jobId){
      for(let i=0;i<180;i++){
        const r = await fetch(`/api/ingestion/jobs/${jobId}`);
        const j = await r.json();
        out(JSON.stringify(j,null,2));

        if(j.status==="done"){
          out("Scraping done. Waiting for processing...");
          await new Promise(r=>setTimeout(r,3000));
          await loadEnrichedCases();
          return;
        }
        if(j.status==="error") return;
        await new Promise(r=>setTimeout(r,1000));
      }
      out("Timeout job.");
    }

    async function loadEnrichedCases(){
      try {
        const r = await fetch("/api/cases?limit=500");
        const data = await r.json();

        out(`Loaded ${data.total} enriched cases`);

        if(data.cases && data.cases.length > 0){
          renderStats(data.cases);
          renderExtractedTable(data.cases);
        }
      } catch(e) {
        out("Error loading enriched cases: " + e.message);
      }
    }

     async function runIngestion(){
      try {
        const dr = getDateRangeString();

        const r = await fetch(`/api/ingestion/run?date_range=${encodeURIComponent(dr)}`, {
          method:"POST",
          cache:"no-store"
        });

        const txt = await r.text();
        out(txt);

        try {
          const j = JSON.parse(txt);
          if (j.job_id) await pollJob(j.job_id);
        } catch (_) {}

      } catch (e) {
        out(String(e.message || e));
      }
    }

    /* =======================
       EXTRACT TXT
       ======================= */
    async function extractTxt(){
      const f = document.getElementById("txtFile").files[0];
      if(!f){ alert("Alege fi»ôier TXT"); return; }

      const fd = new FormData();
      fd.append("file", f);

      const r = await fetch("/api/extract/txt", {method:"POST", body:fd});
      const data = await r.json();

      out(JSON.stringify(data,null,2));
      renderExtractedTable(data);
      renderStats([data]);
    }

    /* =======================
       HEALTH
       ======================= */
    async function health(){
      const r = await fetch("/api/health");
      const j = await r.json();
      document.getElementById("svcPills").innerHTML =
        Object.entries(j).map(([k,v]) =>
          `<span class="pill ${v.ok?"ok":"bad"}">${k}: ${v.ok?"OK":"DOWN"}</span>`
        ).join(" ");
      out(JSON.stringify(j,null,2));
    }


      function toggleMode() {
      const isRange = document.getElementById("modeToggle").checked;
      document.getElementById("singleWrap").style.display = isRange ? "none" : "flex";
      document.getElementById("rangeWrap").style.display  = isRange ? "flex" : "none";
    }

    function pad2(n){ return String(n).padStart(2,"0"); }
    function todayISO(){
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }

    function getDateRangeString() {
      const isRange = document.getElementById("modeToggle").checked;

      if (!isRange) {
        const d = document.getElementById("singleDate").value;
        if (!d) throw new Error("SelecteazƒÉ o datƒÉ.");
        return `${d} TO ${d}`;
      }

      const s = document.getElementById("startDate").value;
      const e = document.getElementById("endDate").value;
      if (!s || !e) throw new Error("SelecteazƒÉ data de √Ænceput »ôi sf√¢r»ôit.");
      if (s > e) throw new Error("Interval invalid: start > end.");
      return `${s} TO ${e}`;
    }

    // seteazƒÉ default la √ÆncƒÉrcare
    window.addEventListener("DOMContentLoaded", () => {
      const t = todayISO();
      document.getElementById("singleDate").value = t;
      document.getElementById("startDate").value = t;
      document.getElementById("endDate").value = t;
    });
    </script>
</body>
</html>
