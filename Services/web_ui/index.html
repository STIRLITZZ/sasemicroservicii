<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Date Juridice – Dashboard</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#0b1220; color:#e6edf3; margin:0}
    .wrap{max-width:1100px; margin:0 auto; padding:24px}
    .grid{display:grid; gap:16px}
    .grid2{grid-template-columns:1fr 1fr}
    .card{background:#0f1a2e; border:1px solid #23314d; border-radius:14px; padding:16px}
    h1{margin:0 0 10px 0; font-size:22px}
    h2{margin:0 0 10px 0; font-size:16px; color:#b7c5ff}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    input,button{border-radius:10px; border:1px solid #2a3a5e; background:#0b1220; color:#e6edf3; padding:10px 12px}
    button{cursor:pointer; background:#1b2f5b}
    button:hover{background:#25407a}
    .pill{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid #2a3a5e}
    .ok{color:#4cffb0}
    .bad{color:#ff6b6b}
    pre{white-space:pre-wrap; word-break:break-word; background:#081024; border:1px solid #23314d; padding:12px; border-radius:12px; max-height:360px; overflow:auto}
    .muted{color:#98a6c7; font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Date Juridice – Interfață</h1>
    <div class="muted">UI → Gateway (/api) → microservicii (extractor + ingestion)</div>

    <div class="grid grid2" style="margin-top:16px">
      <div class="card">
        <h2>Status servicii</h2>
        <div class="row">
          <button onclick="health()">Check</button>
          <span id="svcPills"></span>
        </div>
        <div class="row" style="margin-top:12px">
          <button onclick="loadEnrichedCases()">Încarcă date procesate</button>
          <span class="muted">Afișează toate cazurile din baza de date</span>
        </div>
      </div>

      <div class="card">
          <h2>Ingestion /run</h2>

          <div class="row" style="gap:14px">
            <div class="pill">
              <span>Data</span>
              <label style="display:inline-flex;align-items:center;gap:8px">
                <input id="modeToggle" type="checkbox" onchange="toggleMode()" />
                <span class="muted">Perioadă</span>
              </label>
            </div>

            <!-- Single date -->
            <div id="singleWrap" class="row">
              <input id="singleDate" type="date" />
            </div>

            <!-- Range -->
            <div id="rangeWrap" class="row" style="display:none">
              <input id="startDate" type="date" />
              <span class="muted">→</span>
              <input id="endDate" type="date" />
            </div>

            <button onclick="runIngestion()">Rulează</button>
          </div>

          <div class="muted" style="margin-top:8px">
            Apelează ms_ingestion_web prin gateway.
          </div>
        </div>
    </div>

    <div class="grid" style="margin-top:16px">
      <div class="card">
        <h2>Extract TXT (dosar)</h2>
        <div class="row">
          <input type="file" id="txtFile" />
          <button onclick="extractTxt()">Extrage</button>
        </div>
        <div class="muted" style="margin-top:8px">Încarci TXT → primești JSON/text cu date extrase.</div>
      </div>

      <div class="card">
        <h2>Output</h2>
        <pre id="out">{}</pre>
      </div>
    <div class="card">
      <h2>Statistici</h2>
      <canvas id="chartByDay" height="120"></canvas>
      <canvas id="chartByCourt" height="120" style="margin-top:24px"></canvas>
    </div>

  <div class="card">
  <h2>Tabel – Date extrase</h2>
  <div style="overflow:auto; max-height:420px">
    <table id="dataTable" width="100%" border="1" cellpadding="6" cellspacing="0">
      <thead>
        <tr>
          <th>Instanța</th>
          <th>Localitate</th>
          <th>Dosar</th>
          <th>Tip document</th>
          <th>Domeniu</th>
          <th>Judecător</th>
          <th>Avocat</th>
          <th>Articole</th>
          <th>Procedura</th>
          <th>Soluție</th>
          <th>Data pronunțării</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

    </div>
  </div>

  <script>
    const out = (x) => document.getElementById("out").textContent = x;

    function esc(v){
      return (v ?? "")
        .toString()
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");
    }

    /* =======================
       TABEL DATE EXTRASE TXT
       ======================= */
    function renderExtractedTable(data) {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";

      const rows = Array.isArray(data) ? data : [data];

      for (const d of rows) {
        // Dacă sunt date enriched din pipeline, folosește câmpul extracted
        const ext = d.extracted || d;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(ext.instanta || d.instanta)}</td>
          <td>${esc(ext.localitate || d.localitate)}</td>
          <td>${esc(ext.dosar_nr || d.dosar)}</td>
          <td>${esc(ext.doc_type)}</td>
          <td>${esc(ext.domain)}</td>
          <td>${esc(ext.judecator ?? "—")}</td>
          <td>${esc(ext.avocat ?? "—")}</td>
          <td>${esc((ext.articole || []).join(", "))}</td>
          <td>${esc(ext.procedura)}</td>
          <td><b>${esc(ext.solutie)}</b></td>
          <td>${esc(ext.data_pronuntarii || d.data_pron)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    /* =======================
       STATISTICI
       ======================= */
    function groupCount(items, keyFn) {
      const m = new Map();
      for (const it of items) {
        const k = keyFn(it) ?? "N/A";
        m.set(k, (m.get(k) || 0) + 1);
      }
      return [...m.entries()].sort((a,b)=>b[1]-a[1]);
    }

    function drawBarChart(canvasId, title, labels, values) {
      const c = document.getElementById(canvasId);
      const ctx = c.getContext("2d");
      const W = c.width = c.clientWidth;
      const H = c.height = 140;

      ctx.clearRect(0,0,W,H);
      ctx.fillStyle = "#e6edf3";
      ctx.fillText(title, 10, 16);

      const maxV = Math.max(1, ...values);
      const pad = 30;
      const bw = (W - pad*2) / labels.length;

      labels.forEach((l,i)=>{
        const h = (values[i]/maxV)*(H-60);
        ctx.fillStyle="#25407a";
        ctx.fillRect(pad+i*bw, H-30-h, bw-6, h);
        ctx.fillStyle="#98a6c7";
        ctx.fillText(l.slice(0,12), pad+i*bw, H-10);
      });
    }

    function renderStats(items){
      const byCourt = groupCount(items, x => {
        const ext = x.extracted || x;
        return ext.instanta || x.instanta;
      });
      drawBarChart(
        "chartByCourt",
        "Hotărâri pe instanțe",
        byCourt.slice(0,10).map(x=>x[0]),
        byCourt.slice(0,10).map(x=>x[1])
      );
    }

    /* =======================
       INGESTION JOB
       ======================= */
    async function pollJob(jobId){
      for(let i=0;i<180;i++){
        const r = await fetch(`/api/ingestion/jobs/${jobId}`);
        const j = await r.json();
        out(JSON.stringify(j,null,2));

        if(j.status==="done"){
          // Așteaptă puțin ca datele să fie procesate prin pipeline
          out("Scraping done. Waiting for processing...");
          await new Promise(r=>setTimeout(r,3000));

          // Încarcă datele enriched
          await loadEnrichedCases();
          return;
        }
        if(j.status==="error") return;
        await new Promise(r=>setTimeout(r,1000));
      }
      out("Timeout job.");
    }

    async function loadEnrichedCases(){
      try {
        const r = await fetch("/api/cases?limit=500");
        const data = await r.json();

        out(`Loaded ${data.total} enriched cases`);

        if(data.cases && data.cases.length > 0){
          renderStats(data.cases);
          renderExtractedTable(data.cases);
        }
      } catch(e) {
        out("Error loading enriched cases: " + e.message);
      }
    }

     async function runIngestion(){
      try {
        const dr = getDateRangeString();

        const r = await fetch(`/api/ingestion/run?date_range=${encodeURIComponent(dr)}`, {
          method:"POST",
          cache:"no-store"
        });

        const txt = await r.text();
        out(txt);

        // parsează job_id și pornește poll
        try {
          const j = JSON.parse(txt);
          if (j.job_id) await pollJob(j.job_id);
        } catch (_) {}

      } catch (e) {
        out(String(e.message || e));
      }
    }

    /* =======================
       EXTRACT TXT
       ======================= */
    async function extractTxt(){
      const f = document.getElementById("txtFile").files[0];
      if(!f){ alert("Alege fișier TXT"); return; }

      const fd = new FormData();
      fd.append("file", f);

      const r = await fetch("/api/extract/txt", {method:"POST", body:fd});
      const data = await r.json();

      out(JSON.stringify(data,null,2));
      renderExtractedTable(data);
    }

    /* =======================
       HEALTH
       ======================= */
    async function health(){
      const r = await fetch("/api/health");
      const j = await r.json();
      document.getElementById("svcPills").innerHTML =
        Object.entries(j).map(([k,v]) =>
          `<span class="pill ${v.ok?"ok":"bad"}">${k}: ${v.ok?"OK":"DOWN"}</span>`
        ).join(" ");
      out(JSON.stringify(j,null,2));
    }


      function toggleMode() {
      const isRange = document.getElementById("modeToggle").checked;
      document.getElementById("singleWrap").style.display = isRange ? "none" : "flex";
      document.getElementById("rangeWrap").style.display  = isRange ? "flex" : "none";
    }

    function pad2(n){ return String(n).padStart(2,"0"); }
    function todayISO(){
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }

    function getDateRangeString() {
      const isRange = document.getElementById("modeToggle").checked;

      if (!isRange) {
        const d = document.getElementById("singleDate").value;
        if (!d) throw new Error("Selectează o dată.");
        return `${d} TO ${d}`;
      }

      const s = document.getElementById("startDate").value;
      const e = document.getElementById("endDate").value;
      if (!s || !e) throw new Error("Selectează data de început și sfârșit.");
      if (s > e) throw new Error("Interval invalid: start > end.");
      return `${s} TO ${e}`;
    }

    // setează default la încărcare
    window.addEventListener("DOMContentLoaded", () => {
      const t = todayISO();
      document.getElementById("singleDate").value = t;
      document.getElementById("startDate").value = t;
      document.getElementById("endDate").value = t;
    });
    </script>
</body>
</html>
