<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Date Juridice â€“ Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#0a0e1a; color:#e6edf3; margin:0; padding:0}
    .wrap{max-width:1600px; margin:0 auto; padding:24px}
    .grid{display:grid; gap:20px}
    .grid2{grid-template-columns:1fr 1fr}
    .grid3{grid-template-columns:repeat(3, 1fr)}
    .grid4{grid-template-columns:repeat(4, 1fr)}
    .card{background:#0f1624; border:1px solid #1e293b; border-radius:16px; padding:20px; box-shadow:0 4px 6px rgba(0,0,0,0.3)}
    h1{margin:0 0 8px 0; font-size:28px; font-weight:700}
    h2{margin:0 0 16px 0; font-size:18px; color:#94a3b8; font-weight:600}
    h3{margin:0 0 12px 0; font-size:16px; color:#cbd5e1; font-weight:600}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    input,button,select{border-radius:8px; border:1px solid #334155; background:#1e293b; color:#e6edf3; padding:10px 14px; font-size:14px}
    button{cursor:pointer; background:#3b82f6; border-color:#3b82f6; font-weight:500; transition:all 0.2s}
    button:hover{background:#2563eb; transform:translateY(-1px)}
    select{cursor:pointer}
    .pill{display:inline-flex; gap:8px; align-items:center; padding:6px 12px; border-radius:999px; border:1px solid #334155; background:#1e293b; font-size:13px}
    .ok{color:#10b981; border-color:#10b981}
    .bad{color:#ef4444; border-color:#ef4444}
    pre{white-space:pre-wrap; word-break:break-word; background:#0a0e1a; border:1px solid #1e293b; padding:16px; border-radius:12px; max-height:300px; overflow:auto; font-size:12px}
    .muted{color:#64748b; font-size:13px}
    .chart-container{position:relative; height:350px; margin-top:12px}
    .chart-small{height:280px}
    .stats-summary{display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:16px; margin-bottom:20px}
    .stat-box{background:#1e293b; padding:16px 20px; border-radius:12px; border:1px solid #334155}
    .stat-label{font-size:13px; color:#94a3b8; margin-bottom:6px; font-weight:500}
    .stat-value{font-size:32px; font-weight:700; color:#3b82f6; line-height:1}
    .stat-subtext{font-size:12px; color:#64748b; margin-top:4px}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th{background:#1e293b; padding:12px; text-align:left; color:#cbd5e1; font-weight:600; position:sticky; top:0; border-bottom:2px solid #334155}
    td{padding:10px 12px; border-bottom:1px solid #1e293b}
    tr:hover{background:#1e293b}
    .badge{display:inline-block; padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600}
    .badge-blue{background:#1e3a8a; color:#93c5fd}
    .badge-green{background:#14532d; color:#86efac}
    .badge-red{background:#7f1d1d; color:#fca5a5}
    .badge-yellow{background:#713f12; color:#fde047}
    .chart-builder{background:#0f1624; border:2px dashed #334155; border-radius:16px; padding:24px; margin-top:20px}
    .builder-controls{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:20px}
    .control-group{display:flex; flex-direction:column; gap:6px}
    .control-label{font-size:13px; color:#94a3b8; font-weight:500}
    #customChart{background:#1e293b; border-radius:12px; padding:16px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“Š Dashboard Date Juridice</h1>
    <div class="muted">Platforma de analizÄƒ È™i vizualizare hotÄƒrÃ¢ri judecÄƒtoreÈ™ti</div>

    <div class="grid grid2" style="margin-top:20px">
      <div class="card">
        <h2>âš™ï¸ Control Panel</h2>
        <div class="row">
          <button onclick="health()">ğŸ” Check Status</button>
          <span id="svcPills"></span>
        </div>
        <div class="row" style="margin-top:12px">
          <button onclick="loadEnrichedCases()">ğŸ“¥ ÃncarcÄƒ Date</button>
          <span class="muted">AfiÈ™eazÄƒ toate cazurile procesate</span>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ”„ Scraping Date Noi</h2>
        <div class="row" style="gap:12px">
          <div class="pill">
            <input id="modeToggle" type="checkbox" onchange="toggleMode()" />
            <span>Interval perioadÄƒ</span>
          </div>
          <div id="singleWrap" class="row">
            <input id="singleDate" type="date" />
          </div>
          <div id="rangeWrap" class="row" style="display:none">
            <input id="startDate" type="date" />
            <span class="muted">â†’</span>
            <input id="endDate" type="date" />
          </div>
          <button onclick="runIngestion()">â–¶ï¸ Start</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:20px">
      <h2>ğŸ“¤ Upload & Extract</h2>
      <div class="row">
        <input type="file" id="txtFile" />
        <button onclick="extractTxt()">ğŸ” Extrage Metadate</button>
      </div>
      <pre id="out" style="margin-top:12px">{}</pre>
    </div>

    <!-- Summary Stats -->
    <div class="card" style="margin-top:20px; display:none" id="summaryCard">
      <h2>ğŸ“ˆ Statistici Generale</h2>
      <div class="stats-summary">
        <div class="stat-box">
          <div class="stat-label">Total Cazuri</div>
          <div class="stat-value" id="statTotal">0</div>
          <div class="stat-subtext">HotÄƒrÃ¢ri procesate</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">InstanÈ›e</div>
          <div class="stat-value" id="statCourts">0</div>
          <div class="stat-subtext">InstanÈ›e unice</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">JudecÄƒtori</div>
          <div class="stat-value" id="statJudges">0</div>
          <div class="stat-subtext">JudecÄƒtori identificaÈ›i</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Articole</div>
          <div class="stat-value" id="statArticles">0</div>
          <div class="stat-subtext">ReferinÈ›e legale</div>
        </div>
      </div>
    </div>

    <!-- DWH Insights -->
    <div class="card" style="margin-top:20px; display:none" id="dwhInsights">
      <h2>ğŸ’¡ Insights DWH (Data Warehouse)</h2>
      <p class="muted">Analize automate generate din warehouse</p>
      <div id="insightsList" style="margin-top:12px"></div>
      <div class="row" style="margin-top:16px">
        <button onclick="loadDWHInsights()">ğŸ”„ ReÃ®ncarcÄƒ Insights</button>
      </div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid3" style="margin-top:20px; display:none" id="chartsSection">
      <div class="card">
        <h3>ğŸ›ï¸ Top 15 InstanÈ›e</h3>
        <div class="chart-container chart-small">
          <canvas id="chartByCourt"></canvas>
        </div>
      </div>

      <div class="card">
        <h3>âš–ï¸ Domenii Juridice</h3>
        <div class="chart-container chart-small">
          <canvas id="chartByDomain"></canvas>
        </div>
      </div>

      <div class="card">
        <h3>ğŸ“‹ Tipuri Documente</h3>
        <div class="chart-container chart-small">
          <canvas id="chartByDocType"></canvas>
        </div>
      </div>

      <div class="card">
        <h3>âœ… SoluÈ›ii PronunÈ›ate</h3>
        <div class="chart-container chart-small">
          <canvas id="chartBySolution"></canvas>
        </div>
      </div>

      <div class="card">
        <h3>ğŸ“… DistribuÈ›ie TemporalÄƒ</h3>
        <div class="chart-container chart-small">
          <canvas id="chartByMonth"></canvas>
        </div>
      </div>

      <div class="card">
        <h3>ğŸ‘¨â€âš–ï¸ Top 10 JudecÄƒtori</h3>
        <div class="chart-container chart-small">
          <canvas id="chartByJudge"></canvas>
        </div>
      </div>
    </div>

    <!-- Data Table -->
    <div class="card" style="margin-top:20px; display:none" id="tableSection">
      <h2>ğŸ“„ Tabel Detaliat</h2>
      <div style="overflow:auto; max-height:600px; border:1px solid #1e293b; border-radius:8px">
        <table id="dataTable">
          <thead>
            <tr>
              <th>InstanÈ›a</th>
              <th>Localitate</th>
              <th>Dosar</th>
              <th>Denumire</th>
              <th>Tip Dosar</th>
              <th>Tematica</th>
              <th>JudecÄƒtor</th>
              <th>Avocat</th>
              <th>SoluÈ›ie</th>
              <th>Articole</th>
              <th>Data PronunÈ›Äƒrii</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Chart Builder -->
    <div class="chart-builder" style="display:none" id="chartBuilder">
      <h2>ğŸ¨ Constructor Grafic Personalizat</h2>
      <p class="muted">CreeazÄƒ grafice personalizate din datele tale</p>

      <div class="builder-controls">
        <div class="control-group">
          <label class="control-label">Tip Grafic</label>
          <select id="customChartType" onchange="updateCustomChart()">
            <option value="bar">ğŸ“Š Bare</option>
            <option value="horizontalBar">ğŸ“Š Bare Orizontale</option>
            <option value="pie">ğŸ¥§ Pie Chart</option>
            <option value="doughnut">ğŸ© Doughnut</option>
            <option value="line">ğŸ“ˆ Linie</option>
          </select>
        </div>

        <div class="control-group">
          <label class="control-label">Grupare Date DupÄƒ</label>
          <select id="customGroupBy" onchange="updateCustomChart()">
            <option value="instanta">ğŸ›ï¸ InstanÈ›Äƒ</option>
            <option value="domain">âš–ï¸ Domeniu</option>
            <option value="doc_type">ğŸ“‹ Tip Document</option>
            <option value="solutie">âœ… SoluÈ›ie</option>
            <option value="judecator">ğŸ‘¨â€âš–ï¸ JudecÄƒtor</option>
            <option value="localitate">ğŸ“ Localitate</option>
            <option value="procedura">âš™ï¸ ProcedurÄƒ</option>
          </select>
        </div>

        <div class="control-group">
          <label class="control-label">LimitÄƒ Rezultate</label>
          <select id="customLimit" onchange="updateCustomChart()">
            <option value="5">Top 5</option>
            <option value="10" selected>Top 10</option>
            <option value="15">Top 15</option>
            <option value="20">Top 20</option>
            <option value="all">Toate</option>
          </select>
        </div>

        <div class="control-group">
          <label class="control-label">AcÈ›iune</label>
          <button onclick="updateCustomChart()" style="width:100%">ğŸ”„ ActualizeazÄƒ</button>
        </div>
      </div>

      <div class="card" id="customChart">
        <div class="chart-container">
          <canvas id="customChartCanvas"></canvas>
        </div>
      </div>
    </div>

  </div>

  <script>
    const out = (x) => document.getElementById("out").textContent = x;
    function esc(v){ return (v ?? "").toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

    let allCases = [];
    let charts = {};

    Chart.defaults.color = '#94a3b8';
    Chart.defaults.borderColor = '#334155';
    Chart.defaults.font.family = 'system-ui, -apple-system, Segoe UI, Roboto, Arial';
    Chart.defaults.plugins.legend.labels.color = '#cbd5e1';

    /* =======================
       TABLE RENDERING
       ======================= */
    function renderExtractedTable(data) {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      const rows = Array.isArray(data) ? data : [data];

      for (const d of rows) {
        const ext = d.extracted || d;

        // Truncate long text for denumire and tematica
        const denumire = d.denumire || "â€”";
        const denumireTrunc = denumire.length > 80 ? denumire.substring(0, 77) + "..." : denumire;

        const tematica = d.tematica || "â€”";
        const tematicaTrunc = tematica.length > 60 ? tematica.substring(0, 57) + "..." : tematica;

        // Get tip_dosar with badge color
        const tipDosar = d.tip_dosar || ext.doc_type || "N/A";
        let tipBadgeColor = "badge-blue";
        if (tipDosar.toLowerCase().includes("penal")) tipBadgeColor = "badge-red";
        else if (tipDosar.toLowerCase().includes("civil")) tipBadgeColor = "badge-green";
        else if (tipDosar.toLowerCase().includes("administrativ")) tipBadgeColor = "badge-yellow";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><strong>${esc(ext.instanta || d.instanta || "â€”")}</strong></td>
          <td>${esc(ext.localitate || ext.sediu || "â€”")}</td>
          <td>${esc(ext.dosar_nr || d.dosar || "â€”")}</td>
          <td style="max-width:300px" title="${esc(denumire)}">${esc(denumireTrunc)}</td>
          <td><span class="badge ${tipBadgeColor}">${esc(tipDosar)}</span></td>
          <td style="max-width:250px" title="${esc(tematica)}">${esc(tematicaTrunc)}</td>
          <td>${esc(ext.judecator || d.judecator || "â€”")}</td>
          <td>${esc(ext.avocat || "â€”")}</td>
          <td><span class="badge badge-green"><b>${esc(ext.solutie || 'N/A')}</b></span></td>
          <td>${esc((ext.articole || []).slice(0,3).join(", "))}${(ext.articole||[]).length > 3 ? '...' : ''}</td>
          <td>${esc(ext.data_pronuntarii || d.data_pron || "â€”")}</td>
        `;
        tbody.appendChild(tr);
      }
      document.getElementById("tableSection").style.display = "block";
    }

    /* =======================
       STATISTICS
       ======================= */
    function groupCount(items, keyFn) {
      const m = new Map();
      for (const it of items) {
        const k = keyFn(it) ?? "N/A";
        m.set(k, (m.get(k) || 0) + 1);
      }
      return [...m.entries()].sort((a,b)=>b[1]-a[1]);
    }

    function renderStats(items){
      if (!items || items.length === 0) return;
      allCases = items;

      const uniqueCourts = new Set();
      const uniqueJudges = new Set();
      let totalArticles = 0;

      items.forEach(item => {
        const ext = item.extracted || item;
        if (ext.instanta) uniqueCourts.add(ext.instanta);
        if (ext.judecator) uniqueJudges.add(ext.judecator);
        if (ext.articole) totalArticles += ext.articole.length;
      });

      document.getElementById("statTotal").textContent = items.length;
      document.getElementById("statCourts").textContent = uniqueCourts.size;
      document.getElementById("statJudges").textContent = uniqueJudges.size;
      document.getElementById("statArticles").textContent = totalArticles;

      document.getElementById("summaryCard").style.display = "block";
      document.getElementById("chartsSection").style.display = "grid";
      document.getElementById("chartBuilder").style.display = "block";

      renderAllCharts(items);
      updateCustomChart();
    }

    function renderAllCharts(items) {
      // Chart 1: Courts
      const byCourt = groupCount(items, x => (x.extracted || x).instanta || x.instanta);
      createChart('chartByCourt', 'bar', byCourt.slice(0,15), '#3b82f6');

      // Chart 2: Domains
      const byDomain = groupCount(items, x => (x.extracted || x).domain || 'Nespecificat');
      createPieChart('chartByDomain', byDomain, ['#ef4444', '#3b82f6', '#f59e0b', '#10b981', '#8b5cf6']);

      // Chart 3: Doc Types
      const byDocType = groupCount(items, x => (x.extracted || x).doc_type || 'Nespecificat');
      createPieChart('chartByDocType', byDocType, ['#f59e0b', '#10b981', '#8b5cf6', '#ec4899']);

      // Chart 4: Solutions
      const bySolution = groupCount(items, x => (x.extracted || x).solutie || 'Nespecificat');
      createPieChart('chartBySolution', bySolution, ['#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#3b82f6']);

      // Chart 5: Monthly distribution
      const byMonth = groupCount(items, x => {
        const date = (x.extracted || x).data_pronuntarii || x.data_pron;
        if (!date) return 'N/A';
        return date.substring(0, 7);
      });
      createLineChart('chartByMonth', byMonth.slice(0,12));

      // Chart 6: Judges
      const byJudge = groupCount(items, x => (x.extracted || x).judecator || 'Nespecificat')
        .filter(x => x[0] !== 'Nespecificat' && x[0] !== 'N/A');
      createChart('chartByJudge', 'bar', byJudge.slice(0,10), '#8b5cf6');
    }

    function createChart(id, type, data, color) {
      if (charts[id]) charts[id].destroy();
      charts[id] = new Chart(document.getElementById(id), {
        type: type,
        data: {
          labels: data.map(x=>x[0]),
          datasets: [{
            label: 'NumÄƒr',
            data: data.map(x=>x[1]),
            backgroundColor: color,
            borderWidth: 0
          }]
        },
        options: {
          indexAxis: type === 'bar' ? 'y' : 'x',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { beginAtZero: true, grid: { color: '#1e293b' } },
            y: { grid: { color: '#1e293b' } }
          }
        }
      });
    }

    function createPieChart(id, data, colors) {
      if (charts[id]) charts[id].destroy();
      charts[id] = new Chart(document.getElementById(id), {
        type: 'doughnut',
        data: {
          labels: data.map(x=>x[0]),
          datasets: [{
            data: data.map(x=>x[1]),
            backgroundColor: colors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }

    function createLineChart(id, data) {
      if (charts[id]) charts[id].destroy();
      charts[id] = new Chart(document.getElementById(id), {
        type: 'line',
        data: {
          labels: data.map(x=>x[0]),
          datasets: [{
            label: 'Cazuri',
            data: data.map(x=>x[1]),
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, grid: { color: '#1e293b' } },
            x: { grid: { color: '#1e293b' } }
          }
        }
      });
    }

    /* =======================
       CUSTOM CHART BUILDER
       ======================= */
    function updateCustomChart() {
      if (!allCases || allCases.length === 0) return;

      const chartType = document.getElementById('customChartType').value;
      const groupBy = document.getElementById('customGroupBy').value;
      const limit = document.getElementById('customLimit').value;

      const keyFn = (x) => {
        const ext = x.extracted || x;
        return ext[groupBy] || x[groupBy] || 'Nespecificat';
      };

      let data = groupCount(allCases, keyFn);
      if (limit !== 'all') data = data.slice(0, parseInt(limit));

      if (charts.custom) charts.custom.destroy();

      const colors = ['#3b82f6', '#ef4444', '#f59e0b', '#10b981', '#8b5cf6',
                      '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'];

      if (chartType === 'pie' || chartType === 'doughnut') {
        charts.custom = new Chart(document.getElementById('customChartCanvas'), {
          type: chartType,
          data: {
            labels: data.map(x=>x[0]),
            datasets: [{
              data: data.map(x=>x[1]),
              backgroundColor: colors
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right' } }
          }
        });
      } else if (chartType === 'line') {
        charts.custom = new Chart(document.getElementById('customChartCanvas'), {
          type: 'line',
          data: {
            labels: data.map(x=>x[0]),
            datasets: [{
              label: 'NumÄƒr cazuri',
              data: data.map(x=>x[1]),
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true, grid: { color: '#1e293b' } },
              x: { grid: { color: '#1e293b' } }
            }
          }
        });
      } else {
        const isHorizontal = chartType === 'horizontalBar';
        charts.custom = new Chart(document.getElementById('customChartCanvas'), {
          type: 'bar',
          data: {
            labels: data.map(x=>x[0]),
            datasets: [{
              label: 'NumÄƒr cazuri',
              data: data.map(x=>x[1]),
              backgroundColor: '#3b82f6'
            }]
          },
          options: {
            indexAxis: isHorizontal ? 'y' : 'x',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { beginAtZero: true, grid: { color: '#1e293b' } },
              y: { grid: { color: '#1e293b' } }
            }
          }
        });
      }
    }

    /* =======================
       API CALLS
       ======================= */
    async function pollJob(jobId){
      for(let i=0;i<180;i++){
        const r = await fetch(`/api/ingestion/jobs/${jobId}`);
        const j = await r.json();
        out(JSON.stringify(j,null,2));
        if(j.status==="done"){
          out("âœ… Scraping complet. Se proceseazÄƒ datele...");
          await new Promise(r=>setTimeout(r,3000));
          await loadEnrichedCases();
          return;
        }
        if(j.status==="skipped"){
          out(`â„¹ï¸ ${j.message || "Perioada a fost deja procesatÄƒ"}`);
          out("ğŸ“Š ÃncÄƒrcare date existente...");
          await loadEnrichedCases();
          return;
        }
        if(j.status==="error") return;
        await new Promise(r=>setTimeout(r,1000));
      }
      out("â±ï¸ Timeout.");
    }

    async function loadEnrichedCases(){
      try {
        // ConstruieÈ™te URL-ul cu filtrare pe date dacÄƒ sunt selectate
        let url = "/api/cases?limit=10000";

        const isRangeMode = document.getElementById("modeToggle").checked;
        let startDate, endDate;

        if (isRangeMode) {
          // Mod interval
          startDate = document.getElementById("startDate").value;
          endDate = document.getElementById("endDate").value;
        } else {
          // Mod datÄƒ unicÄƒ - foloseÈ™te aceeaÈ™i datÄƒ pentru start È™i end
          const singleDate = document.getElementById("singleDate").value;
          if (singleDate) {
            startDate = singleDate;
            endDate = singleDate;
          }
        }

        // AdaugÄƒ parametrii de datÄƒ la URL dacÄƒ existÄƒ
        if (startDate) url += `&start_date=${startDate}`;
        if (endDate) url += `&end_date=${endDate}`;

        const r = await fetch(url);

        if (!r.ok) {
          out(`âŒ Eroare API: ${r.status} ${r.statusText}`);
          return;
        }

        const data = await r.json();

        // VerificÄƒ dacÄƒ avem structura corectÄƒ
        if (!data || typeof data !== 'object') {
          out(`âŒ RÄƒspuns invalid de la server`);
          return;
        }

        const total = data.total || 0;
        const totalUnfiltered = data.total_unfiltered || total;
        const cases = data.cases || [];

        // Mesaj care aratÄƒ filtrarea
        let msg = `âœ… ÃncÄƒrcat ${cases.length} / ${total} cazuri`;
        if (startDate || endDate) {
          msg += ` (filtrate din ${totalUnfiltered} total)`;
          if (startDate && endDate && startDate === endDate) {
            msg += ` - doar data ${startDate}`;
          } else if (startDate && endDate) {
            msg += ` - interval ${startDate} â†’ ${endDate}`;
          } else if (startDate) {
            msg += ` - dupÄƒ ${startDate}`;
          } else {
            msg += ` - Ã®nainte de ${endDate}`;
          }
        }
        out(msg);

        if(cases.length > 0){
          renderStats(cases);
          renderExtractedTable(cases);
        } else {
          out("â„¹ï¸ Nu existÄƒ cazuri procesate Ã®ncÄƒ. RuleazÄƒ scraping-ul mai Ã®ntÃ¢i.");
        }

        // ÃncarcÄƒ È™i insights DWH
        await loadDWHInsights();
      } catch(e) {
        out("âŒ Eroare: " + e.message);
        console.error("Load enriched cases error:", e);
      }
    }

    async function loadDWHInsights(){
      try {
        const r = await fetch("/api/dwh/insights");
        const data = await r.json();

        const insightsList = document.getElementById("insightsList");
        insightsList.innerHTML = "";

        if(data.insights && data.insights.length > 0){
          data.insights.forEach(insight => {
            const div = document.createElement("div");
            div.className = "pill ok";
            div.style.marginBottom = "8px";
            div.style.display = "flex";
            div.style.justifyContent = "space-between";
            div.style.width = "100%";
            div.innerHTML = `
              <span>${insight.message}</span>
              <span class="badge badge-blue">${insight.value}</span>
            `;
            insightsList.appendChild(div);
          });
          document.getElementById("dwhInsights").style.display = "block";
        }
      } catch(e) {
        console.error("DWH insights error:", e);
      }
    }

    async function runIngestion(){
      try {
        const dr = getDateRangeString();
        const r = await fetch(`/api/ingestion/run?date_range=${encodeURIComponent(dr)}`, {
          method:"POST", cache:"no-store"
        });
        const txt = await r.text();
        out(txt);
        try {
          const j = JSON.parse(txt);
          if (j.job_id) await pollJob(j.job_id);
        } catch (_) {}
      } catch (e) {
        out("âŒ " + String(e.message || e));
      }
    }

    async function extractTxt(){
      const f = document.getElementById("txtFile").files[0];
      if(!f){ alert("SelecteazÄƒ un fiÈ™ier TXT"); return; }
      const fd = new FormData();
      fd.append("file", f);
      const r = await fetch("/api/extract/txt", {method:"POST", body:fd});
      const data = await r.json();
      out(JSON.stringify(data,null,2));
      renderExtractedTable(data);
      renderStats([data]);
    }

    async function health(){
      const r = await fetch("/api/health");
      const j = await r.json();
      document.getElementById("svcPills").innerHTML =
        Object.entries(j).map(([k,v]) =>
          `<span class="pill ${v.ok?"ok":"bad"}">${k}: ${v.ok?"âœ…":"âŒ"}</span>`
        ).join(" ");
      out(JSON.stringify(j,null,2));
    }

    /* =======================
       UTILITY
       ======================= */
    function toggleMode() {
      const isRange = document.getElementById("modeToggle").checked;
      document.getElementById("singleWrap").style.display = isRange ? "none" : "flex";
      document.getElementById("rangeWrap").style.display  = isRange ? "flex" : "none";
    }

    function pad2(n){ return String(n).padStart(2,"0"); }
    function todayISO(){
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }

    function getDateRangeString() {
      const isRange = document.getElementById("modeToggle").checked;
      if (!isRange) {
        const d = document.getElementById("singleDate").value;
        if (!d) throw new Error("SelecteazÄƒ o datÄƒ.");
        return `${d} TO ${d}`;
      }
      const s = document.getElementById("startDate").value;
      const e = document.getElementById("endDate").value;
      if (!s || !e) throw new Error("SelecteazÄƒ data de Ã®nceput È™i sfÃ¢rÈ™it.");
      if (s > e) throw new Error("Interval invalid.");
      return `${s} TO ${e}`;
    }

    window.addEventListener("DOMContentLoaded", () => {
      const t = todayISO();
      document.getElementById("singleDate").value = t;
      document.getElementById("startDate").value = t;
      document.getElementById("endDate").value = t;
    });
  </script>
</body>
</html>
